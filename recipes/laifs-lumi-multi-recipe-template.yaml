name: laifs-lumi-multi-recipe
steps:
  - name: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}
    template: rocm/Ubuntu2404_Rocm6
    force: False
    base: ubuntu:{{ubuntu_tag}}
    env:
      - AMDGPU_VERSION={{amd_gpu_version}}
      - ROCM_VERSION={{rocm_version}}
      - EXTRA_LOCALES="{{extra_locales | join(' ')}}"
      - EXTRA_PACKAGES="{{extra_packages | join(' ')}}"
  - name: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}
    base: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}
    template: libfabric/Ubuntu_Rocm_Slingshot
    force: False
    env:
      - XPMEM_CLONE_URL={{xpmem_clone_url}}
      - XPMEM_GIT_COMMIT={{xpmem_git_commit}}
      - XPMEM_VERSION={{xpmem_version}}
      - XPMEM_KERNEL_BASE_SRC={{xpmem_kernel_base_src}}
      - XPMEM_KERNEL_GENERIC_SRC={{xpmem_kernel_generic_src}}
      - XPMEM_KERNEL_ID={{xpmem_kernel_id}}
      #
      - CASSINI_HEADERS_VERSION={{cassini_headers_version}}
      #
      - CXI_HEADERS_VERSION={{cxi_headers_version}}
      - CXI_HEADERS_CLONE_URL={{cxi_headers_clone_url}}
      - CXI_HEADERS_GIT_COMMIT={{cxi_headers_git_commit}}
      #
      - LIBCXI_VERSION={{libcxi_version}}
      - LIBCXI_CLONE_URL={{libcxi_clone_url}}
      - LIBCXI_GIT_COMMIT={{libcxi_git_commit}}
      #
      - LIBFABRIC_VERSION={{libfabric_version}}
      - LIBFABRIC_CLONE_URL={{libfabric_clone_url}}
      - LIBFABRIC_GIT_COMMIT={{libfabric_git_commit}}
    export:
      name: "laifs-lumi-libfabric-{{libfabric_version}}"
  - name: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}-mpich-{{mpich_version}}
    base: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}
    template: mpich/Ubuntu_Rocm_Slingshot
    force: False
    env:
      - MPICH_VERSION={{mpich_version}}
      - OSU_VERSION={{osu_version}}
      - AWS_OFI_RCCL_VERSION={{aws_ofi_rccl_version}}
      - AWS_OFI_RCCL_COMMIT={{aws_ofi_rccl_commit}}
      - RCCL_TESTS_GIT_COMMIT={{rccl_tests_git_commit}}
      - RCCL_TESTS_GPU_ARCHS={{rccl_tests_gpu_archs}}
      - RCCL_TESTS_VERSION={{rccl_tests_version}}
    export:
      name: "laifs-lumi-mpich-{{mpich_version}}"
  - name: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}-mpich-{{mpich_version}}-torch-{{torch_version}}
    base: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}-mpich-{{mpich_version}}
    template: torch/Venv_Torch
    force: True
    env:
      - TORCH_VERSION={{torch_version}}
      #
      - PYTORCH_TRITON_URL={{pytorch_triton_url}}
      - TORCHAUDIO_URL={{torchaudio_url}}
      - TORCHVISION_URL={{torchvision_url}}
      - TORCH_URL={{torch_url}}
      - XFORMERS_URL={{xformers_url}}
  - name: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}-mpich-{{mpich_version}}-torch-{{torch_version}}-multi
    base: ubuntu-{{ubuntu_tag}}-rocm-{{rocm_version}}-libfabric-{{libfabric_version}}-mpich-{{mpich_version}}-torch-{{torch_version}}
    template: multi/Rocm_Multipurpose
    force: False
    env:
      - APEX_GIT_REPO={{apex_git_repo}}
      - APEX_GIT_COMMIT={{apex_git_commit}}
      #
      - BITSANDBYTES_COMMIT={{bitsandbytes_commit}}
      - BITSANDBYTES_REPO_URL={{bitsandbytes_repo_url}}
      #
      - CAUSAL_CONV1D_REPO={{causal_conv1d_repo}}
      - CAUSAL_CONV1D_COMMIT={{causal_conv1d_commit}}
      #
      - DEEPSPEED_VERSION={{deepspeed_version}}
      #
      - EXTRA_APT_PACKAGES="{{extra_apt_packages | join(' ')}}"
      - EXTRA_PIP_PACKAGES="{{extra_pip_packages |Â join(' ')}}"
      #
      - FLASH_ATTENTION_REPO_COMMIT={{flash_attention_repo_commit}}
      - FLASH_ATTENTION_REPO_URL={{flash_attention_repo_url}}
      #
      - MULTI_IMAGE_GPU_ARCH={{multi_image_gpu_arch}}
      #
      - VLLM_COMMIT={{vllm_commit}}
      #
      - WRETAG_URL={{wretag_url}}
      #
    export:
      name: "laifs-lumi-multi"
      def: |
        %runscript
        if [ "${ROCR_USE_SLURM_LOCALID}" = 1 ] && [ -n "${SLURM_LOCALID}" ]; then
            export ROCR_VISIBLE_DEVICES="$SLURM_LOCALID"
        fi
        exec "$@"
